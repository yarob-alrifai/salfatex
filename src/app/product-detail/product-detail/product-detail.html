<section class="bg-slate-50" *ngIf="product$ | async as product; else loading">
  <div class="mx-auto max-w-6xl px-4 py-12 sm:px-6 lg:px-8">
    <div class="grid gap-10 lg:grid-cols-[1.15fr_0.85fr] lg:items-start xl:grid-cols-[1.2fr_0.8fr]">
      <div class="space-y-6">
        <ng-container *ngIf="product.mainImageUrl || product.galleryUrls?.length; else noImages">
          <div
            class="overflow-hidden rounded-3xl bg-white p-3 shadow-xl shadow-slate-900/5 ring-1 ring-slate-100"
          >
            <img
              class="h-full w-full rounded-2xl object-cover object-center"
              [src]="getMainImage(product)"
              [alt]="product.name"
            />
          </div>

          <ng-container *ngIf="getGalleryImages(product) as galleryImages">
            <div
              *ngIf="galleryImages.length"
              class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-4"
            >
              <img
                *ngFor="let image of galleryImages; trackBy: trackImage"
                class="h-28 w-full rounded-2xl object-cover object-center shadow-sm ring-1 ring-slate-200 transition duration-200 hover:scale-[1.02]"
                [src]="image"
                [alt]="product.name"
              />
            </div>
          </ng-container>
        </ng-container>

        <ng-template #noImages>
          <div
            class="flex min-h-[22rem] items-center justify-center rounded-3xl border border-dashed border-slate-300 bg-white/70 text-center text-slate-500"
          >
            لا توجد صور متاحة لهذا المنتج حالياً
          </div>
        </ng-template>
      </div>

      <div
        class="space-y-6 rounded-3xl bg-white/90 p-6 shadow-xl shadow-slate-900/5 ring-1 ring-slate-100 backdrop-blur"
      >
        <div class="flex flex-col gap-3">
          <div class="flex items-center gap-3 text-sm text-slate-500">
            <span
              class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 font-medium"
            >
              المنتج رقم
              <span class="font-semibold text-slate-700">#{{ product.id }}</span>
            </span>
          </div>

          <h1 class="text-3xl font-bold leading-tight text-slate-900 md:text-4xl">
            {{ product.name }}
          </h1>

          <p class="text-2xl font-semibold text-emerald-600">
            {{ product.price | currency : 'USD' : 'symbol' : '1.0-0' }}
          </p>

          <p class="text-base font-medium text-slate-600" *ngIf="product.color">
            اللون: {{ product.color }}
          </p>
        </div>

        <p class="text-base leading-relaxed text-slate-600" *ngIf="product.description">
          {{ product.description }}
        </p>

        <div
          *ngIf="product.materials as materials"
          class="rounded-2xl border border-slate-200 bg-slate-50/80 p-5"
        >
          <h2 class="text-lg font-semibold text-slate-800">الخامات</h2>
          <p class="mt-2 text-sm leading-7 text-slate-600">
            {{ materials }}
          </p>
        </div>

        <div
          *ngIf="product.features?.length"
          class="rounded-2xl border border-slate-200 bg-white p-5"
        >
          <h3 class="text-lg font-semibold text-slate-800">المميزات</h3>
          <ul class="mt-4 space-y-2 text-sm text-slate-600">
            <li *ngFor="let feature of product.features" class="flex items-start gap-2">
              <span
                class="mt-1 inline-flex h-2.5 w-2.5 flex-none rounded-full bg-indigo-500"
              ></span>
              <span>{{ feature }}</span>
            </li>
          </ul>
        </div>

        <div class="flex flex-col gap-5 pt-2">
          <ng-container *ngIf="getQuantity(product.id) === 0; else quantityControls">
            <button
              type="button"
              class="inline-flex w-full items-center justify-center gap-2 rounded-full bg-gradient-to-r from-indigo-500 via-sky-500 to-blue-500 px-6 py-3 text-base font-semibold text-white shadow-lg shadow-sky-500/30 transition duration-200 hover:from-indigo-600 hover:via-sky-600 hover:to-blue-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2"
              (click)="addToCart(product)"
            >
              أضف إلى السلة
            </button>
          </ng-container>

          <ng-template #quantityControls>
            <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
              <div
                class="inline-flex items-center rounded-full border border-slate-200 bg-slate-100/70 text-slate-900 shadow-sm"
              >
                <button
                  type="button"
                  class="h-11 w-11 text-xl font-semibold transition hover:text-indigo-600"
                  (click)="decrement(product)"
                  aria-label="إنقاص الكمية"
                >
                  −
                </button>
                <span class="min-w-[3rem] text-center text-base font-semibold">
                  {{ getQuantity(product.id) }}
                </span>
                <button
                  type="button"
                  class="h-11 w-11 text-xl font-semibold transition hover:text-indigo-600"
                  (click)="increment(product)"
                  aria-label="زيادة الكمية"
                >
                  +
                </button>
              </div>

              <button
                type="button"
                class="inline-flex w-full items-center justify-center gap-2 rounded-full bg-gradient-to-r from-indigo-500 via-sky-500 to-blue-500 px-6 py-3 text-base font-semibold text-white shadow-lg shadow-sky-500/30 transition duration-200 hover:from-indigo-600 hover:via-sky-600 hover:to-blue-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 sm:w-auto"
                (click)="addToCart(product)"
              >
                تحديث السلة
              </button>
            </div>
          </ng-template>
        </div>

        <a
          class="inline-flex items-center gap-2 text-sm font-semibold text-indigo-600 transition hover:text-indigo-700"
          [routerLink]="['/categories', product.categoryId]"
        >
          <span aria-hidden="true">⬅︎</span>
          المزيد من المنتجات
        </a>
      </div>
    </div>
  </div>
</section>

<ng-template #loading>
  <div class="flex min-h-[50vh] items-center justify-center bg-slate-50 px-4 py-12 text-slate-500">
    ...يتم تحميل المنتج
  </div>
</ng-template>
