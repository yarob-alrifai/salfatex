<section class="p-8 bg-gray-50 min-h-screen">
  <header class="mb-8 text-center">
    <h2 class="text-3xl font-bold text-indigo-600">ุฅุฏุงุฑุฉ ุงูุชุตูููุงุช ุงููุฑุนูุฉ</h2>
    <p class="text-gray-600 mt-2">
      ูู ุจุฑุจุท ุงูุชุตูููุงุช ุงููุฑุนูุฉ ุจุงูุชุตูููุงุช ุงูุฑุฆูุณูุฉ ูุน ุฅููุงููุฉ ุฅุถุงูุฉ ุตูุฑุฉ ููุตู ููู ุชุตููู ูุฑุนู.
    </p>
  </header>

  <form
    [formGroup]="form"
    (ngSubmit)="saveSubcategory()"
    class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-white p-6 rounded-xl shadow text-right"
  >
    <label class="flex flex-col gap-2">
      <span class="font-medium text-gray-700">ุงูุชุตููู ุงูุฑุฆูุณู</span>
      <select
        formControlName="categoryId"
        class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
      >
        <option value="" disabled>ุงุฎุชุฑ ุงูุชุตููู</option>
        <option *ngFor="let category of categories$ | async" [value]="category.id">
          {{ category.name }}
        </option>
      </select>
    </label>

    <label class="flex flex-col gap-2">
      <span class="font-medium text-gray-700">ุงุณู ุงูุชุตููู ุงููุฑุนู</span>
      <input
        formControlName="name"
        placeholder="ุฃููุดุฉ ุฑุฌุงููุฉ"
        class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
      />
    </label>

    <label class="flex flex-col gap-2 md:col-span-2">
      <span class="font-medium text-gray-700">ุงููุตู</span>
      <textarea
        formControlName="description"
        rows="3"
        placeholder="ุฃุฏุฎู ูุตููุง ูุฎุชุตุฑูุง ููุชุตููู ุงููุฑุนู"
        class="border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-400"
      ></textarea>
    </label>

    <label class="flex flex-col gap-2 md:col-span-2">
      <span class="font-medium text-gray-700">ุตูุฑุฉ ุชุนุฑูููุฉ</span>
      <input
        type="file"
        accept="image/*"
        (change)="onImageChange($event)"
        class="border border-dashed border-indigo-300 rounded-lg p-3 bg-indigo-50 text-indigo-700"
      />

      <ng-container *ngIf="createPreviewUrl as preview">
        <span class="text-sm text-gray-500">ูุนุงููุฉ ุงูุตูุฑุฉ ุจุนุฏ ุงููุต</span>
        <img
          [src]="preview"
          alt="ูุนุงููุฉ ุตูุฑุฉ ุงูุชุตููู ุงููุฑุนู"
          class="mt-2 w-32 h-32 rounded-lg object-cover self-end border border-gray-200"
        />
      </ng-container>
    </label>

    <div class="md:col-span-2 flex flex-col gap-3 md:flex-row md:items-center md:justify-end">
      <button
        type="submit"
        class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-6 rounded-lg shadow transition"
      >
        ๐พ ุญูุธ ุงูุชุตููู ุงููุฑุนู
      </button>
    </div>

    <p class="md:col-span-2 text-center text-green-600 font-medium" *ngIf="feedback()">
      {{ feedback() }}
    </p>
  </form>

  <div
    *ngIf="showCreateCropper"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4"
  >
    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-2xl p-6 space-y-4">
      <header class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-800">ูุต ุตูุฑุฉ ุงูุชุตููู ุงููุฑุนู</h3>
        <button
          type="button"
          (click)="cancelCreateCrop()"
          class="text-gray-500 hover:text-gray-700 text-xl"
          aria-label="ุฅุบูุงู ุฃุฏุงุฉ ุงููุต"
        >
          โ
        </button>
      </header>
      <image-cropper
        [imageChangedEvent]="createImageChangedEvent"
        [maintainAspectRatio]="true"
        [aspectRatio]="1"
        [resizeToWidth]="800"
        format="png"
        [cropperMinWidth]="200"
        [cropperMinHeight]="200"
        (imageCropped)="onCreateImageCropped($event)"
        (imageLoaded)="onCreateImageLoaded()"
        (loadImageFailed)="onCreateImageLoadFailed()"
        class="block h-96"
      ></image-cropper>
      <div class="flex justify-end gap-3">
        <button
          type="button"
          (click)="cancelCreateCrop()"
          class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300"
        >
          ุฅูุบุงุก
        </button>
        <button
          type="button"
          [disabled]="!createCropReady"
          (click)="confirmCreateCrop()"
          class="px-4 py-2 rounded-lg bg-indigo-600 text-white disabled:opacity-50 disabled:cursor-not-allowed"
        >
          ุงุนุชูุงุฏ ุงููุต
        </button>
      </div>
    </div>
  </div>
  <div
    *ngIf="showCreateCropper"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4"
  >
    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-2xl p-6 space-y-4">
      <header class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-800">ูุต ุตูุฑุฉ ุงูุชุตููู ุงููุฑุนู</h3>
        <button
          type="button"
          (click)="cancelCreateCrop()"
          class="text-gray-500 hover:text-gray-700 text-xl"
          aria-label="ุฅุบูุงู ุฃุฏุงุฉ ุงููุต"
        >
          โ
        </button>
      </header>
      <image-cropper
        [imageChangedEvent]="createImageChangedEvent"
        [maintainAspectRatio]="true"
        [aspectRatio]="1"
        [resizeToWidth]="800"
        format="png"
        [cropperMinWidth]="200"
        [cropperMinHeight]="200"
        (imageCropped)="onCreateImageCropped($event)"
        (imageLoaded)="onCreateImageLoaded()"
        (loadImageFailed)="onCreateImageLoadFailed()"
        class="block h-96"
      ></image-cropper>
      <div class="flex justify-end gap-3">
        <button
          type="button"
          (click)="cancelCreateCrop()"
          class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300"
        >
          ุฅูุบุงุก
        </button>
        <button
          type="button"
          [disabled]="!createCropReady"
          (click)="confirmCreateCrop()"
          class="px-4 py-2 rounded-lg bg-indigo-600 text-white disabled:opacity-50 disabled:cursor-not-allowed"
        >
          ุงุนุชูุงุฏ ุงููุต
        </button>
      </div>
    </div>
  </div>

  <section class="mt-10 space-y-6" *ngIf="subcategoriesView$ | async as subcategories">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between text-right">
      <div class="relative w-full md:w-80">
        <span class="absolute inset-y-0 left-3 flex items-center text-gray-400">๐</span>
        <input
          type="search"
          [formControl]="searchControl"
          placeholder="ุงุจุญุซ ุนู ุชุตููู ูุฑุนู..."
          class="w-full border border-gray-300 rounded-lg py-2 pr-3 pl-10 text-right focus:outline-none focus:ring-2 focus:ring-indigo-400"
        />
      </div>
      <div class="flex flex-col gap-1 md:items-end">
        <p class="text-gray-600">
          ุงุฎุชุฑ ุงูุชุตููู ุงูุฑุฆูุณู ูู ุงููููุฐุฌ ุฃุนูุงู ูุนุฑุถ ุงูุชุตูููุงุช ุงููุฑุนูุฉ ุงููุฑุชุจุทุฉ ุจู.
        </p>
        <span class="text-sm text-gray-500"
          >ุฅุฌูุงูู ุงูุชุตูููุงุช ุงููุฑุนูุฉ ุงููุนุฑูุถุฉ: {{ subcategories.length }}</span
        >
      </div>
    </div>

    <div class="bg-white rounded-xl shadow overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 text-right">
          <thead class="bg-gray-100 text-gray-700 text-sm">
            <tr>
              <th class="px-4 py-3 font-semibold">ุงูุงุณู</th>
              <th class="px-4 py-3 font-semibold">ุงููุตู</th>
              <th class="px-4 py-3 font-semibold">ุงูุชุตููู ุงูุฑุฆูุณู</th>
              <th class="px-4 py-3 font-semibold">ุงูุตูุฑุฉ</th>
              <th class="px-4 py-3 font-semibold">ุงูุฅุฌุฑุงุกุงุช</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 text-sm text-gray-700">
            <tr *ngFor="let subcategory of subcategories" class="hover:bg-gray-50">
              <td class="px-4 py-3 font-medium text-gray-900">{{ subcategory.name }}</td>
              <td class="px-4 py-3">{{ subcategory.description || 'ูุง ููุฌุฏ ูุตู' }}</td>
              <td class="px-4 py-3">{{ subcategory.categoryName }}</td>
              <td class="px-4 py-3">
                <ng-container *ngIf="subcategory.imageUrl; else noImage">
                  <img
                    [src]="subcategory.imageUrl"
                    alt="ุตูุฑุฉ {{ subcategory.name }}"
                    class="w-16 h-16 object-cover rounded-lg border border-gray-200 inline-block"
                  />
                </ng-container>
                <ng-template #noImage>โ</ng-template>
              </td>
              <td class="px-4 py-3">
                <div class="flex items-center justify-end gap-2">
                  <button
                    type="button"
                    (click)="startEdit(subcategory)"
                    class="bg-amber-500 hover:bg-amber-600 text-white py-1 px-3 rounded-lg shadow transition"
                  >
                    โ๏ธ ุชุนุฏูู
                  </button>
                  <button
                    type="button"
                    (click)="deleteSubcategory(subcategory)"
                    class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-lg shadow transition"
                  >
                    ๐๏ธ ุญุฐู
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="!subcategories.length" class="p-6 text-center text-gray-500">
        ูุง ุชูุฌุฏ ุชุตูููุงุช ูุฑุนูุฉ ูุทุงุจูุฉ ููุงุฎุชูุงุฑ ุงูุญุงูู.
      </div>
    </div>
  </section>

  <!-- Edit modal -->
  <div
    class="fixed inset-0 z-40 flex items-center justify-center bg-black/40 backdrop-blur"
    *ngIf="isEditModalOpen()"
  >
    <div
      class="w-full max-w-3xl bg-white max-h-[90vh] rounded-2xl shadow-xl p-6 space-y-6 overflow-y-auto"
    >
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold text-gray-800">ุชุนุฏูู ุงูุชุตููู ุงููุฑุนู</h3>
        <button
          type="button"
          (click)="closeEditModal()"
          class="text-gray-500 hover:text-gray-700"
          aria-label="ุฅุบูุงู"
        >
          โ๏ธ
        </button>
      </div>

      <form
        class="grid grid-cols-1 md:grid-cols-2 gap-4"
        [formGroup]="editForm"
        (ngSubmit)="saveSubcategoryEdits()"
      >
        <label class="flex flex-col text-right">
          <span class="mb-1 font-medium text-gray-700">ุงูุชุตููู ุงูุฑุฆูุณู</span>
          <select
            formControlName="categoryId"
            class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
          >
            <option value="" disabled>ุงุฎุชุฑ ุงูุชุตููู</option>
            <option *ngFor="let category of categories$ | async" [value]="category.id">
              {{ category.name }}
            </option>
          </select>
        </label>

        <label class="flex flex-col text-right">
          <span class="mb-1 font-medium text-gray-700">ุงุณู ุงูุชุตููู ุงููุฑุนู</span>
          <input
            formControlName="name"
            class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
          />
        </label>

        <label class="flex flex-col text-right md:col-span-2">
          <span class="mb-1 font-medium text-gray-700">ุงููุตู</span>
          <textarea
            formControlName="description"
            rows="3"
            class="border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-400"
          ></textarea>
        </label>

        <ng-container *ngIf="editingSubcategory() as subcategory">
          <div class="flex flex-col text-right gap-2 md:col-span-2">
            <span class="font-medium text-gray-700">ุงูุตูุฑุฉ ุงูุญุงููุฉ</span>
            <img
              *ngIf="subcategory.imageUrl; else noSubcategoryImage"
              [src]="subcategory.imageUrl"
              [alt]="subcategory.name"
              class="w-32 h-32 object-cover rounded-lg border border-gray-200 self-end"
            />
            <ng-template #noSubcategoryImage>
              <span class="text-sm text-gray-500">ูุง ุชูุฌุฏ ุตูุฑุฉ ุญุงููุฉ ููุฐุง ุงูุชุตููู ุงููุฑุนู.</span>
            </ng-template>
          </div>
        </ng-container>

        <label class="flex flex-col text-right md:col-span-2">
          <span class="mb-1 font-medium text-gray-700">ุชุบููุฑ ุงูุตูุฑุฉ</span>
          <input
            type="file"
            accept="image/*"
            (change)="onEditImageChange($event)"
            class="border border-dashed border-indigo-300 rounded-lg p-3 bg-indigo-50 text-sm"
          />

          <span class="text-xs text-gray-500 mt-1"
            >ุงุชุฑู ุงูุญูู ูุงุฑุบูุง ููุงุญุชูุงุธ ุจุงูุตูุฑุฉ ุงูุญุงููุฉ.</span
          >

          <ng-container *ngIf="editPreviewUrl as preview">
            <span class="text-sm text-gray-500 mt-2">ูุนุงููุฉ ุงูุตูุฑุฉ ุจุนุฏ ุงููุต</span>
            <img
              [src]="preview"
              alt="ูุนุงููุฉ ุงูุตูุฑุฉ ุงูุฌุฏูุฏุฉ"
              class="mt-2 w-32 h-32 rounded-lg object-cover self-end border border-gray-200"
            />
          </ng-container>
        </label>

        <div class="md:col-span-2 flex items-center justify-end gap-2">
          <button
            type="button"
            (click)="closeEditModal()"
            class="px-4 py-2 rounded-lg border border-gray-300 text-sm hover:bg-gray-100"
          >
            ุฅูุบุงุก
          </button>
          <button
            type="submit"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-6 rounded-lg shadow transition"
          >
            ๐พ ุญูุธ ุงูุชุนุฏููุงุช
          </button>
        </div>

        <p class="md:col-span-2 text-center text-red-600 font-medium" *ngIf="editFeedback()">
          {{ editFeedback() }}
        </p>
      </form>
    </div>
  </div>

  <div
    *ngIf="showEditCropper"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4"
  >
    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-2xl p-6 space-y-4">
      <header class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-800">ูุต ุตูุฑุฉ ุงูุชุตููู ุงููุฑุนู</h3>
        <button
          type="button"
          (click)="cancelEditCrop()"
          class="text-gray-500 hover:text-gray-700 text-xl"
          aria-label="ุฅุบูุงู ุฃุฏุงุฉ ุงููุต"
        >
          โ
        </button>
      </header>
      <image-cropper
        [imageChangedEvent]="editImageChangedEvent"
        [maintainAspectRatio]="true"
        [aspectRatio]="1"
        [resizeToWidth]="800"
        format="png"
        [cropperMinWidth]="200"
        [cropperMinHeight]="200"
        (imageCropped)="onEditImageCropped($event)"
        (imageLoaded)="onEditImageLoaded()"
        (loadImageFailed)="onEditImageLoadFailed()"
        class="block h-96"
      ></image-cropper>
      <div class="flex justify-end gap-3">
        <button
          type="button"
          (click)="cancelEditCrop()"
          class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300"
        >
          ุฅูุบุงุก
        </button>
        <button
          type="button"
          [disabled]="!editCropReady"
          (click)="confirmEditCrop()"
          class="px-4 py-2 rounded-lg bg-indigo-600 text-white disabled:opacity-50 disabled:cursor-not-allowed"
        >
          ุงุนุชูุงุฏ ุงููุต
        </button>
      </div>
    </div>
  </div>
</section>
