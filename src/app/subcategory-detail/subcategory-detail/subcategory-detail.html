<section class="subcategory-detail" *ngIf="viewModel$ | async as vm; else loading">
  <header class="subcategory-detail__header">
    <a class="subcategory-detail__back" [routerLink]="['/categories', vm.categoryId]">
      ← عودة إلى القائمة السابقة
    </a>

    <div class="subcategory-detail__info" *ngIf="vm.subcategory as subcategory">
      <img
        class="subcategory-detail__image"
        [src]="subcategory.imageUrl"
        [alt]="subcategory.name"
      />

      <div class="subcategory-detail__text">
        <h1>{{ subcategory.name }}</h1>
        <p>{{ subcategory.description }}</p>
      </div>
    </div>
  </header>

  <section class="subcategory-detail__products">
    <h2 class="subcategory-detail__products-title">المنتجات المتاحة ({{ vm.products.length }})</h2>

    <div *ngIf="vm.products.length; else empty" class="subcategory-detail__product-grid">
      <article
        *ngFor="let product of vm.products; trackBy: trackByProductId"
        class="subcategory-detail__product"
      >
        <a
          class="subcategory-detail__product-link"
          [routerLink]="[
            '/categories',
            vm.categoryId,
            'subcategories',
            vm.subcategory?.id ?? vm.subcategoryId,
            'products',
            product.id
          ]"
          (click)="$event.stopPropagation()"
        >
          <img [src]="product.mainImageUrl" [alt]="product.name" />
          <div>
            <h3>{{ product.name }}</h3>
            <p *ngIf="product.price" class="subcategory-detail__price">
              {{ product.price | currency : 'SYP' : 'symbol-narrow' : '1.0-0' }}
            </p>
            <p *ngIf="product.color" class="subcategory-detail__color">
              اللون: {{ product.color }}
            </p>
          </div>
        </a>

        <div class="subcategory-detail__actions">
          <ng-container *ngIf="getQuantity(product.id) === 0; else quantityControls">
            <button type="button" (click)="addToCart($event, product)">أضف إلى السلة</button>
          </ng-container>

          <ng-template #quantityControls>
            <div class="subcategory-detail__quantity">
              <button type="button" (click)="decrement($event, product)" aria-label="إنقاص الكمية">
                −
              </button>
              <span>{{ getQuantity(product.id) }}</span>
              <button type="button" (click)="increment($event, product)" aria-label="زيادة الكمية">
                +
              </button>
            </div>
          </ng-template>
        </div>
      </article>
    </div>
  </section>
</section>

<ng-template #loading>
  <div class="subcategory-detail__loading">جاري تحميل بيانات القسم الفرعي...</div>
</ng-template>

<ng-template #empty>
  <div class="subcategory-detail__empty">لا توجد منتجات ضمن هذا القسم الفرعي حالياً.</div>
</ng-template>
